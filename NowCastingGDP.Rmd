---
title: "NowCasting GDP"
author: "Minhaz Khan, Navin Chandradat, Bobak Ahmar, Vincent La"
date: "14/09/2019"
output: html_document
---
The problem that we will be tackling is the prediction of the quarters of the fiscal year. To do this, we will employ a technique called 
NowCasting, which is the prediction of the current, and near future by examining data that occur at different frequencies and with 
different lags. To begin, we'll first plot the monthly and quarterly GDPs against eachother. Next, we will fit a model based on the data 
provided and examine the correlation between different months and quarters.

```{r, fig.height=3, fig.width=5}
# load required packages
library(cansim)
library(tidyverse)
library(lubridate)
library(modelr)
library(broom)
library(astsa)

#### Problem 2 ####

# plot quarterly & monthly GDP 
#This code is from the Draft
get_cansim_vector( c( 
  "monthly GDP" = "v65201210",
  "quarterly GDP" = "v1000000673") ,
    start_time = "2015-01-01" ) %>% 
  normalize_cansim_values() %>% 
  ggplot( aes( x = Date, y = VALUE, col = label ) ) +
  geom_line() + geom_point() + ylab("Chained (2012) dollars") +
  ggtitle("Problem 2: Plot of quarterly & monthly GDP")


```
The graph shows that both the monthly and quarterly GDPs increase at almost exactly the same rate. This suggests that
perhaps the two are highly correlated.


In order to get a closer look at the existing pattern, we separated the monthly and quarterly GDP and then graphed them.
```{r}
get_cansim_vector( c( 
  "monthly GDP (basic prices)" = "v65201210",
  "quarterly GDP (expend-based)" = "v62305723") ,
    start_time = "2010-01-01" ) %>% 
  normalize_cansim_values() %>% 
  ggplot( aes( x = Date, y = VALUE, col = label ) ) +
  geom_line() + geom_point() + ylab("Chained (2012) dollars")
```

```{r}
get_cansim_vector( c( 
  "monthly GDP (basic prices)" = "v65201210",
  "quarterly GDP (expend-based)" = "v62305723") ,
    start_time = "2009-01-01" ) %>% 
    normalize_cansim_values() -> ncastDF
```

```{r}
ncastDF %>% group_by(label) %>% summarise(time_mean = mean(VALUE), time_var = var(VALUE), time_med = median(VALUE))
```

```{r}
ncastDF %>% spread(label,VALUE) -> ncastSP
ncastSP
```

```{r}
glimpse(ncastDF)
ncastDF %>% filter(label == "quarterly GDP (expend-based)" & year(Date) ==2010) %>% ggplot(aes(Date,VALUE,col=label))+geom_line()

ncastDF %>% filter(label == "monthly GDP (basic prices)" & year(Date) ==2010) %>% ggplot(aes(Date,VALUE,col=label))+geom_line()
ncastDF %>% filter(label == "monthly GDP (basic prices)" & year(Date) ==2011) %>% ggplot(aes(Date,VALUE,col=label))+geom_line()
ncastDF %>% filter(label == "monthly GDP (basic prices)" & year(Date) ==2012) %>% ggplot(aes(Date,VALUE,col=label))+geom_line()
ncastDF %>% filter(label == "monthly GDP (basic prices)" & year(Date) ==2013) %>% ggplot(aes(Date,VALUE,col=label))+geom_line()
```

Now what we want to do is use a basic regression model to help us further our understanding of the data.

```{r}
#Trying to fit a linear model


ncast.1 = lm(VALUE~label+Date, data = ncastDF)
summary(ncast.1)
ggplot(ncast.1,aes(x=Date,y= VALUE,group = Date))+geom_boxplot()

```

Here, we can see that the variance between the values are more or less the same time progresses, while the mean steadily increases in an almost linear fashion.

```{r}
ncastSP %>% filter(year(Date) >= 2018 & year(Date) <= 2019) -> ncast1

ncast1 %>% mutate(monthly = case_when(
                                  `monthly GDP (basic prices)` != NA ~ 0,
                                  is.na(`monthly GDP (basic prices)`) ~ 0,
                                  TRUE ~ NA_real_))

ncast1 %>% mutate(monthly = case_when(
                                  `monthly GDP (basic prices)` == NA ~ 0, 
                                  is.na(`monthly GDP (basic prices)`) ~ 0,
                                  TRUE ~ `monthly GDP (basic prices)`)) %>%
  mutate(quarterly = case_when(
                                  `quarterly GDP (expend-based)` == NA ~ 0, 
                                  is.na(`quarterly GDP (expend-based)`) ~ 0,
                                  TRUE ~ `quarterly GDP (expend-based)`))



```

*Plan of Attack*
Since the data we have is clearly dependent, i.e. the GDP for previous months would be dependent on eachother, we could use time series 
methodologies to estimate the present and near future, in particular, we will attempt to fit an ARMA model for the data.

In order to do this, we must construct a model of our time series. The essence of how we want to construct our model is that we want to 
create a three month cohort for each quarter and attach them together. So what this means is that we want to create these quarterly bins 
for each month starting with one year and experimenting with that. For example, if we were to predict the GDP for the first quarter of 
2019, we would use the monthly GDP data from the previous 3 months. 

Furthermore, in order to make full use of these methodologies, we’ll also check that our model is stationary. We may obtain evidence of 
this by looking back even further, and see if there are any discrepancies between the joint distribution of monthly GDPs, by using ACF and PACF plots. Additionally, we may check if the mean and variance functions are constant, or if γ(s,t) is function of h = s-t. If at least one of these are not fulfilled we may have to change our model such that it will. There also may be the problem of seasonality in the mean, for example the GDP of a country that relies heavily on tourist will fluctuate up and down throughout the year. In this case, we could employ the moving average smoother to get rid of seasonality.

After this, we can use the ACF and PACF plots to determine the order of our ARMA model. To check if our model is good, we should look at the residuals and see that they have no pattern and are normally distributed. If they are not, we will refit the model as needed.



